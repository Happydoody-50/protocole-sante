<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Protocole Essentiel Plus</title>

  <!-- Anti-cache (aide √©norm√©ment sur Android/PWA) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg:#0b1220;
      --bg2:#070c16;
      --card:#111b2e;
      --card2:#0c1528;
      --line:rgba(255,255,255,.10);
      --text:#eaf1ff;
      --muted:#9fb0d0;
      --blue:#3b82f6;
      --purple:#8b5cf6;
      --green:#22c55e;
      --yellow:#f59e0b;
      --red:#ef4444;
      --pill:#172444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,var(--bg2),var(--bg));
      color:var(--text);
      padding-bottom:88px; /* nav bottom */
    }
    .wrap{max-width:520px; margin:0 auto; padding:14px}
    .title{
      text-align:center; padding:10px 0 14px;
    }
    .title h1{
      margin:0;
      font-size:26px;
      letter-spacing:.2px;
      background:linear-gradient(90deg,#60a5fa,#a78bfa);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      font-weight:800;
    }
    .title .sub{color:var(--muted); font-size:12px; margin-top:6px}

    .card{
      background:rgba(17,27,46,.92);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 28px rgba(0,0,0,.25);
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .between{justify-content:space-between}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .h2{
      margin:0 0 10px;
      font-size:20px;
      font-weight:800;
      color:var(--text);
    }
    .h3{
      margin:0 0 10px;
      font-size:16px;
      font-weight:750;
      color:#93c5fd;
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .btn{
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 12px;
      font-weight:750;
      color:white;
      background:var(--blue);
    }
    .btn:active{transform:translateY(1px)}
    .btn.ghost{
      background:transparent;
      border:1px solid var(--line);
      color:var(--text);
    }
    .btn.green{background:var(--green)}
    .btn.purple{background:var(--purple)}
    .btn.red{
      background:transparent;
      border:1px solid rgba(239,68,68,.6);
      color:#ffd6d6;
    }

    input, textarea, select{
      width:100%;
      background:var(--card2);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:74px; resize:vertical}
    input[type="date"], input[type="time"]{padding:9px 12px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}

    .momentHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .momentTitle{
      display:flex; align-items:center; gap:8px;
      font-size:18px; font-weight:850;
      color:#60a5fa;
      text-transform:capitalize;
    }
    .momentTime{font-size:12px; color:var(--muted)}
    .mic{
      width:42px; height:42px; border-radius:999px;
      border:none; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      color:white; background:var(--purple);
    }
    .mic.recording{background:var(--red); animation:pulse 1.2s infinite}
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(239,68,68,.45)}
      70%{box-shadow:0 0 0 12px rgba(239,68,68,0)}
      100%{box-shadow:0 0 0 0 rgba(239,68,68,0)}
    }

    .suppBtn{
      width:100%;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      padding:12px;
      border-radius:14px;
      border:2px solid transparent;
      background:rgba(255,255,255,.04);
      cursor:pointer;
      transition:.15s ease;
      text-align:left;
    }
    .suppBtn:hover{background:rgba(255,255,255,.06)}
    .suppBtn.checked{
      background:rgba(34,197,94,.16);
      border-color:rgba(34,197,94,.55);
    }
    .suppBtn.disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .suppLeft{display:flex; align-items:flex-start; gap:10px; flex:1}
    .dot{
      width:22px; height:22px; border-radius:999px;
      border:2px solid rgba(255,255,255,.35);
      display:flex; align-items:center; justify-content:center;
      margin-top:2px;
      flex:0 0 auto;
    }
    .dot.checked{
      background:rgba(34,197,94,.9);
      border-color:rgba(34,197,94,.9);
    }
    .suppName{font-weight:800}
    .suppDose{font-size:12px; color:var(--muted); margin-top:2px}
    .infoBtn{
      flex:0 0 auto;
      width:34px; height:34px;
      border-radius:999px;
      border:none;
      background:rgba(59,130,246,.95);
      color:white;
      cursor:pointer;
    }
    .restNote{font-size:12px; color:var(--yellow); margin:6px 0 0 8px}

    .voiceBox{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(139,92,246,.45);
      background:rgba(139,92,246,.14);
      color:#e9ddff;
      font-size:13px;
    }

    .slRow{display:flex; align-items:center; gap:10px; margin-top:8px}
    .slRow .tag{width:78px; font-size:12px; color:var(--muted)}
    input[type="range"]{flex:1}
    .slVal{width:30px; text-align:right; font-weight:800; color:#93c5fd}

    .centerCard{
      text-align:center;
      padding:18px 12px;
    }
    .bigPct{font-size:46px; font-weight:900; color:#60a5fa; line-height:1}
    .divider{height:1px; background:var(--line); margin:12px 0}

    /* Analysis bars */
    .barRow{display:flex; align-items:center; gap:10px; margin:10px 0}
    .dayLabel{width:46px; color:var(--muted); font-size:12px}
    .barWrap{
      flex:1;
      height:28px;
      border-radius:999px;
      overflow:hidden;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      position:relative;
    }
    .barFill{height:100%}
    .barText{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-weight:850; font-size:12px; color:white;
      text-shadow:0 1px 6px rgba(0,0,0,.35);
    }

    /* Modal */
    .modalBg{
      position:fixed; inset:0; background:rgba(0,0,0,.78);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modalBg.show{display:flex}
    .modal{
      width:100%;
      max-width:420px;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(17,27,46,.98);
      padding:16px;
    }
    .modal h3{margin:0 0 10px; font-size:18px; color:#60a5fa}
    .sectionTitle{font-weight:900; margin:10px 0 4px}
    .secGreen{color:#86efac}
    .secRed{color:#fca5a5}
    .secPurple{color:#d8b4fe}
    .secYellow{color:#fde68a}
    .modal p{margin:0; color:var(--text); font-size:13px; line-height:1.35}
    .modal .btn{width:100%; margin-top:12px}

    /* Bottom nav */
    .nav{
      position:fixed; left:0; right:0; bottom:0;
      background:rgba(17,27,46,.98);
      border-top:1px solid var(--line);
      padding:8px 8px 10px;
      z-index:100;
    }
    .navInner{max-width:520px; margin:0 auto; display:flex; justify-content:space-around}
    .navBtn{
      border:none; cursor:pointer; background:transparent;
      color:rgba(234,241,255,.65);
      padding:6px 10px;
      border-radius:12px;
      display:flex; flex-direction:column; align-items:center; gap:4px;
      min-width:86px;
    }
    .navBtn.active{
      color:#60a5fa;
      background:rgba(59,130,246,.16);
    }
    .navIcon{font-size:18px}
    .navLabel{font-size:11px; font-weight:750}

    .toast{
      position:fixed; left:50%; bottom:92px; transform:translateX(-50%);
      background:rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.16);
      padding:10px 12px;
      border-radius:14px;
      z-index:1000;
      max-width:92vw;
      display:none;
      font-size:13px;
    }
    .toast.show{display:block}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">
      <h1>Protocole Essentiel Plus</h1>
      <div class="sub">Suivi intelligent ‚Äî donn√©es locales ‚Äî GitHub Pages friendly</div>
    </div>

    <!-- DAILY -->
    <div id="view-daily" class="view">
      <div class="card">
        <div class="row between">
          <div>
            <div class="h2">Suivi Quotidien</div>
            <div class="small muted">S√©lectionne une date et coche les suppl√©ments par moment.</div>
          </div>
          <div style="min-width:170px">
            <label>Date</label>
            <input id="selectedDate" type="date" />
          </div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div id="momentsContainer"></div>

      <div style="height:12px"></div>

      <div class="card centerCard">
        <div class="bigPct" id="dayPct">0%</div>
        <div class="muted">Protocole compl√©t√©</div>
        <div class="small muted" id="dayPctHint" style="margin-top:6px;"></div>
      </div>
    </div>

    <!-- ANALYSIS -->
    <div id="view-analysis" class="view" style="display:none">
      <div class="card">
        <div class="row between">
          <div>
            <div class="h2">Analyse</div>
            <div class="small muted">Conformit√© des 7 derniers jours et export CSV.</div>
          </div>
          <button id="exportCSV" class="btn green">‚¨á Export CSV</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card centerCard" style="background:linear-gradient(135deg, rgba(34,197,94,.18), rgba(59,130,246,.18))">
        <div class="bigPct" id="weekAvg">0%</div>
        <div class="muted">Conformit√© hebdomadaire</div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="h3">7 Derniers jours</div>
        <div id="weekBars"></div>
      </div>
    </div>

    <!-- GUIDE -->
    <div id="view-guide" class="view" style="display:none">
      <div class="card">
        <div class="row between">
          <div>
            <div class="h2">Guide D√©taill√©</div>
            <div class="small muted">Avantages / inconv√©nients / m√©canisme / synergies.</div>
          </div>
          <span class="badge">üìö</span>
        </div>
      </div>

      <div style="height:12px"></div>

      <div id="guideList"></div>
    </div>

    <!-- SETTINGS -->
    <div id="view-settings" class="view" style="display:none">
      <div class="card">
        <div class="h2">Param√®tres</div>
        <div class="small muted">Heures de notification (affich√©es) + infos + nettoyage.</div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="h3">‚è∞ Heures de notification</div>

        <div style="margin-bottom:10px">
          <label>üåÖ Matin</label>
          <input id="time-matin" type="time" />
        </div>

        <div style="margin-bottom:10px">
          <label>‚òÄÔ∏è Midi</label>
          <input id="time-midi" type="time" />
        </div>

        <div style="margin-bottom:10px">
          <label>üåô Soir</label>
          <input id="time-soir" type="time" />
        </div>

        <button id="saveTimes" class="btn">üíæ Sauvegarder</button>
      </div>

      <div style="height:12px"></div>

      <div class="card" style="background:linear-gradient(135deg, rgba(139,92,246,.18), rgba(236,72,153,.12))">
        <div class="h3" style="color:#e9ddff">üì± √Ä propos</div>
        <div class="small muted">
          Protocole Essentiel Plus ‚Äî v1 (HTML/JS)<br/>
          Toutes tes donn√©es sont stock√©es localement sur ton appareil (localStorage).
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div class="h3" style="color:#fca5a5">üßπ Nettoyage</div>
        <button id="clearToday" class="btn red">Effacer la journ√©e s√©lectionn√©e</button>
        <div style="height:10px"></div>
        <button id="clearAll" class="btn red">Tout effacer (sur cet appareil)</button>
        <div class="small muted" style="margin-top:10px">
          ‚ö†Ô∏è ‚ÄúTout effacer‚Äù supprime protocoles coch√©s, notes vocales et scores.
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Info -->
  <div id="modalBg" class="modalBg" role="dialog" aria-modal="true">
    <div class="modal" id="modalCard">
      <h3 id="modalTitle">Info</h3>

      <div class="sectionTitle secGreen">üì¶ Dosage</div>
      <p id="modalDosage"></p>

      <div class="sectionTitle secYellow">üí° Rappel</div>
      <p id="modalReminder"></p>

      <div class="divider"></div>

      <div class="sectionTitle secGreen">‚úÖ Avantages</div>
      <p id="modalAdv"></p>

      <div class="sectionTitle secRed">‚ö†Ô∏è Inconv√©nients</div>
      <p id="modalCons"></p>

      <div class="sectionTitle secPurple">üî¨ M√©canisme</div>
      <p id="modalMech"></p>

      <div class="sectionTitle secYellow">ü§ù Synergies</div>
      <p id="modalSyn"></p>

      <button class="btn" id="closeModal">Fermer</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Bottom Nav -->
  <div class="nav">
    <div class="navInner">
      <button class="navBtn active" data-view="daily">
        <div class="navIcon">üïí</div>
        <div class="navLabel">Quotidien</div>
      </button>
      <button class="navBtn" data-view="analysis">
        <div class="navIcon">üìà</div>
        <div class="navLabel">Analyse</div>
      </button>
      <button class="navBtn" data-view="guide">
        <div class="navIcon">üìñ</div>
        <div class="navLabel">Guide</div>
      </button>
      <button class="navBtn" data-view="settings">
        <div class="navIcon">‚öôÔ∏è</div>
        <div class="navLabel">R√©glages</div>
      </button>
    </div>
  </div>

  <script>
    // =========================
    // Donn√©es: protocole Claude
    // =========================
    const APP_VERSION = "v1";
    const protocol = {
      matin: [
        { name: "Bleu de M√©thyl√®ne", dosage: "5 gouttes", reminder: "√Ä jeun, dilu√© dans un verre d‚Äôeau" },
        { name: "Complexe B", dosage: "1 capsule", reminder: "Avec le petit-d√©jeuner pour meilleure absorption" },
        { name: "Vita-D3", dosage: "1 capsule", reminder: "Avec un repas contenant des graisses" }
      ],
      midi: [
        { name: "Curcuma", dosage: "500mg", reminder: "Avec poivre noir pour biodisponibilit√©" },
        { name: "Gingembre", dosage: "250mg", reminder: "Pendant ou apr√®s le repas" }
      ],
      soir: [
        { name: "Ashwagandha", dosage: "300mg", reminder: "Au d√Æner (3 semaines ON / 1 semaine OFF)" },
        { name: "Zinc", dosage: "15mg", reminder: "Au d√Æner, pas avec calcium" },
        { name: "Synermag/Magn√©sium", dosage: "200mg", reminder: "Au coucher pour favoriser le sommeil" }
      ]
    };

    const supplementGuide = {
      "Bleu de M√©thyl√®ne": {
        avantages: "Am√©liore fonction mitochondriale, neuroprotecteur, antioxydant puissant",
        inconvenients: "Coloration urine/selles, interactions m√©dicamenteuses, √©viter si G6PD",
        mecanisme: "Am√©liore la production d‚Äô√©nergie cellulaire en optimisant la cha√Æne respiratoire",
        synergies: "Fonctionne bien avec NAD+ et CoQ10"
      },
      "Complexe B": {
        avantages: "√ânergie, m√©tabolisme, fonction cognitive, humeur",
        inconvenients: "Urine jaune fluo, possible naus√©e √† jeun",
        mecanisme: "Cofacteurs essentiels pour production d‚Äô√©nergie et neurotransmetteurs",
        synergies: "Magn√©sium pour activation optimale"
      },
      "Vita-D3": {
        avantages: "Immunit√©, os, humeur, fonction musculaire",
        inconvenients: "Toxicit√© si surdosage, calcification si K2 absent",
        mecanisme: "Hormone st√©ro√Øde qui r√©gule 3000+ g√®nes",
        synergies: "ESSENTIEL avec K2 et graisses alimentaires"
      },
      "Curcuma": {
        avantages: "Anti-inflammatoire puissant, antioxydant, neuroprotecteur",
        inconvenients: "Biodisponibilit√© faible seul, possible trouble gastrique",
        mecanisme: "Inhibe NF-kB et autres voies inflammatoires",
        synergies: "Poivre noir (√ó2000 absorption) et gingembre"
      },
      "Gingembre": {
        avantages: "Anti-naus√©e, anti-inflammatoire, digestion",
        inconvenients: "Peut fluidifier sang, √©viter avant chirurgie",
        mecanisme: "Compos√©s ging√©rols inhibent inflammation",
        synergies: "Curcuma et citron pour effet synergique"
      },
      "Ashwagandha": {
        avantages: "Adaptog√®ne anti-stress, cortisol, sommeil, force",
        inconvenients: "Cycle requis (d√©sensibilisation), somnolence possible",
        mecanisme: "R√©gule axe HPA et r√©cepteurs GABA",
        synergies: "Magn√©sium et Rhodiola pour gestion stress"
      },
      "Zinc": {
        avantages: "Immunit√©, testost√©rone, cicatrisation, 300+ enzymes",
        inconvenients: "Naus√©e si estomac vide, bloque cuivre si exc√®s",
        mecanisme: "Cofacteur enzymatique et r√©gulateur immunitaire",
        synergies: "Vitamine C, √©viter calcium simultan√©"
      },
      "Synermag/Magn√©sium": {
        avantages: "Sommeil, relaxation musculaire, 600+ r√©actions enzymatiques",
        inconvenients: "Effet laxatif selon forme, interagit avec antibiotiques",
        mecanisme: "Antagoniste calcium, active GABA, d√©tend syst√®me nerveux",
        synergies: "Vitamine B6 et D3 pour absorption optimale"
      }
    };

    // =========================
    // Stockage
    // =========================
    const LS = {
      dailyData: "protocolData_v1",
      wellbeing: "wellbeingScores_v1",
      voice: "voiceNotes_v1",
      times: "notificationTimes_v1"
    };

    const getObj = (k, fallback) => {
      try { return JSON.parse(localStorage.getItem(k)) ?? fallback; }
      catch { return fallback; }
    };
    const setObj = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    // =========================
    // State
    // =========================
    let currentView = "daily";
    let selectedDate = new Date().toISOString().split("T")[0];
    let dailyData = getObj(LS.dailyData, {});          // key: date-moment-supp => bool
    let wellbeingScores = getObj(LS.wellbeing, {});    // key: date-moment => {√ânergie,Immunit√©,Stress}
    let voiceNotes = getObj(LS.voice, {});             // key: date-moment => string
    let notificationTimes = getObj(LS.times, { matin:"08:00", midi:"12:00", soir:"20:00" });
    let isRecording = false;

    // =========================
    // Utils
    // =========================
    const $ = (id) => document.getElementById(id);

    const toastEl = $("toast");
    let toastT = null;
    const toast = (msg) => {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastT);
      toastT = setTimeout(()=>toastEl.classList.remove("show"), 2200);
    };

    const keyTaken = (date, moment, suppName) => `${date}-${moment}-${suppName}`;
    const keyMoment = (date, moment) => `${date}-${moment}`;

    // Ashwagandha: 3 semaines ON / 1 OFF
    const isAshwagandhaRestWeek = (dateStr) => {
      const d = new Date(dateStr + "T00:00:00");
      const start = new Date(d.getFullYear(), 0, 1);
      const weekOfYear = Math.floor((d - start) / 604800000); // 7*24*60*60*1000
      return (weekOfYear % 4) === 3;
    };

    const supportsSpeech = () => ("webkitSpeechRecognition" in window);

    const getDayCompletion = (dateStr) => {
      let total = 0, completed = 0;

      Object.keys(protocol).forEach(moment => {
        protocol[moment].forEach(supp => {
          if (supp.name === "Ashwagandha" && isAshwagandhaRestWeek(dateStr)) return;
          total++;
          if (dailyData[keyTaken(dateStr, moment, supp.name)]) completed++;
        });
      });

      const pct = total > 0 ? Math.round((completed / total) * 100) : 0;
      return { pct, total, completed };
    };

    const getWeekData = () => {
      const arr = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date(selectedDate + "T00:00:00");
        d.setDate(d.getDate() - i);
        const ds = d.toISOString().split("T")[0];
        const day = d.toLocaleDateString("fr-FR",{weekday:"short"});
        const { pct } = getDayCompletion(ds);
        arr.push({ date: ds, day, completion: pct });
      }
      return arr;
    };

    const saveAll = () => {
      setObj(LS.dailyData, dailyData);
      setObj(LS.wellbeing, wellbeingScores);
      setObj(LS.voice, voiceNotes);
      setObj(LS.times, notificationTimes);
    };

    // =========================
    // Rendering
    // =========================
    const renderNav = () => {
      document.querySelectorAll(".navBtn").forEach(btn => {
        const v = btn.getAttribute("data-view");
        btn.classList.toggle("active", v === currentView);
      });
      ["daily","analysis","guide","settings"].forEach(v => {
        const el = $("view-" + v);
        el.style.display = (v === currentView) ? "" : "none";
      });
    };

    const renderDaily = () => {
      $("selectedDate").value = selectedDate;

      const container = $("momentsContainer");
      container.innerHTML = "";

      Object.entries(protocol).forEach(([moment, supplements]) => {
        const card = document.createElement("div");
        card.className = "card";
        card.style.marginTop = "12px";

        const isRest = (moment === "soir") && isAshwagandhaRestWeek(selectedDate);

        const header = document.createElement("div");
        header.className = "momentHeader";

        const left = document.createElement("div");
        left.className = "momentTitle";
        left.innerHTML =
          (moment === "matin" ? "üåÖ" : moment === "midi" ? "‚òÄÔ∏è" : "üåô") +
          " " + moment +
          ` <span class="badge" style="margin-left:6px">üîî <span class="momentTime">${notificationTimes[moment] || ""}</span></span>`;

        const micBtn = document.createElement("button");
        micBtn.className = "mic" + (isRecording ? " recording" : "");
        micBtn.title = supportsSpeech() ? "Dicter une note" : "Reconnaissance vocale non support√©e";
        micBtn.innerHTML = "üé§";
        micBtn.onclick = () => startVoiceRecording(moment);

        header.appendChild(left);
        header.appendChild(micBtn);

        card.appendChild(header);

        supplements.forEach(supp => {
          const isAshwa = (supp.name === "Ashwagandha");
          const restWeek = isAshwa && isAshwagandhaRestWeek(selectedDate);
          const checked = !!dailyData[keyTaken(selectedDate, moment, supp.name)];

          const wrapper = document.createElement("div");
          wrapper.style.marginBottom = "10px";

          const btn = document.createElement("button");
          btn.className = "suppBtn" + (checked ? " checked" : "") + (restWeek ? " disabled" : "");
          btn.disabled = restWeek;

          btn.onclick = () => {
            if (restWeek) return;
            const k = keyTaken(selectedDate, moment, supp.name);
            dailyData[k] = !dailyData[k];
            setObj(LS.dailyData, dailyData);
            renderDaily(); // refresh
            renderDayPct();
          };

          const leftBlock = document.createElement("div");
          leftBlock.className = "suppLeft";

          const dot = document.createElement("div");
          dot.className = "dot" + (checked ? " checked" : "");
          dot.textContent = checked ? "‚úì" : "";

          const txt = document.createElement("div");
          txt.innerHTML = `<div class="suppName">${supp.name}</div><div class="suppDose">${supp.dosage}</div>`;

          leftBlock.appendChild(dot);
          leftBlock.appendChild(txt);

          const info = document.createElement("button");
          info.className = "infoBtn";
          info.innerHTML = "i";
          info.title = "Info";
          info.onclick = (e) => {
            e.stopPropagation();
            openInfoModal(supp);
          };

          btn.appendChild(leftBlock);
          btn.appendChild(info);

          wrapper.appendChild(btn);

          if (restWeek) {
            const p = document.createElement("div");
            p.className = "restNote";
            p.textContent = "Semaine de repos";
            wrapper.appendChild(p);
          }

          card.appendChild(wrapper);
        });

        // Notes vocales affich√©es
        const noteKey = keyMoment(selectedDate, moment);
        if (voiceNotes[noteKey] && voiceNotes[noteKey].trim()) {
          const vb = document.createElement("div");
          vb.className = "voiceBox";
          vb.textContent = "üé§ " + voiceNotes[noteKey].trim();
          card.appendChild(vb);
        }

        // Bien-√™tre (0-10)
        const wbKey = keyMoment(selectedDate, moment);
        const wb = wellbeingScores[wbKey] || { "√ânergie": 5, "Immunit√©": 5, "Stress": 5 };

        const wbWrap = document.createElement("div");
        wbWrap.style.marginTop = "10px";
        wbWrap.innerHTML = `<div class="small" style="font-weight:850;color:rgba(234,241,255,.85)">Bien-√™tre ${moment}</div>`;

        ["√ânergie","Immunit√©","Stress"].forEach(cat => {
          const row = document.createElement("div");
          row.className = "slRow";

          const tag = document.createElement("div");
          tag.className = "tag";
          tag.textContent = cat;

          const range = document.createElement("input");
          range.type = "range";
          range.min = "0";
          range.max = "10";
          range.value = (wb[cat] ?? 5);

          const val = document.createElement("div");
          val.className = "slVal";
          val.textContent = range.value;

          range.oninput = () => { val.textContent = range.value; };
          range.onchange = () => {
            wellbeingScores[wbKey] = wellbeingScores[wbKey] || {};
            wellbeingScores[wbKey][cat] = parseInt(range.value, 10);
            setObj(LS.wellbeing, wellbeingScores);
          };

          row.appendChild(tag);
          row.appendChild(range);
          row.appendChild(val);

          wbWrap.appendChild(row);
        });

        card.appendChild(wbWrap);

        container.appendChild(card);
      });

      renderDayPct();
    };

    const renderDayPct = () => {
      const { pct, total, completed } = getDayCompletion(selectedDate);
      $("dayPct").textContent = pct + "%";
      $("dayPctHint").textContent = total ? `${completed}/${total} prises coch√©es` : "Aucun suppl√©ment actif";
    };

    const renderAnalysis = () => {
      const data = getWeekData();
      const avg = Math.round(data.reduce((s,x)=>s + x.completion,0) / data.length);
      $("weekAvg").textContent = avg + "%";

      const weekBars = $("weekBars");
      weekBars.innerHTML = "";

      data.forEach(d => {
        const row = document.createElement("div");
        row.className = "barRow";

        const day = document.createElement("div");
        day.className = "dayLabel";
        day.textContent = d.day;

        const wrap = document.createElement("div");
        wrap.className = "barWrap";

        const fill = document.createElement("div");
        fill.className = "barFill";
        fill.style.width = d.completion + "%";

        // couleur selon score
        let col = "rgba(239,68,68,.85)";
        if (d.completion >= 80) col = "rgba(34,197,94,.85)";
        else if (d.completion >= 50) col = "rgba(245,158,11,.85)";
        fill.style.background = col;

        const txt = document.createElement("div");
        txt.className = "barText";
        txt.textContent = d.completion + "%";

        wrap.appendChild(fill);
        wrap.appendChild(txt);

        row.appendChild(day);
        row.appendChild(wrap);

        weekBars.appendChild(row);
      });
    };

    const renderGuide = () => {
      const gl = $("guideList");
      gl.innerHTML = "";

      Object.entries(supplementGuide).forEach(([name, info]) => {
        const card = document.createElement("div");
        card.className = "card";
        card.style.marginBottom = "12px";

        const h = document.createElement("div");
        h.className = "h3";
        h.style.fontSize = "18px";
        h.textContent = name;

        const s1 = document.createElement("div");
        s1.innerHTML = `<div class="sectionTitle secGreen">‚úÖ Avantages</div><p>${escapeHtml(info.avantages)}</p>`;

        const s2 = document.createElement("div");
        s2.innerHTML = `<div class="sectionTitle secRed">‚ö†Ô∏è Inconv√©nients</div><p>${escapeHtml(info.inconvenients)}</p>`;

        const s3 = document.createElement("div");
        s3.innerHTML = `<div class="sectionTitle secPurple">üî¨ M√©canisme</div><p>${escapeHtml(info.mecanisme)}</p>`;

        const s4 = document.createElement("div");
        s4.innerHTML = `<div class="sectionTitle secYellow">ü§ù Synergies</div><p>${escapeHtml(info.synergies)}</p>`;

        card.appendChild(h);
        card.appendChild(s1);
        card.appendChild(s2);
        card.appendChild(s3);
        card.appendChild(s4);

        gl.appendChild(card);
      });
    };

    const renderSettings = () => {
      $("time-matin").value = notificationTimes.matin || "08:00";
      $("time-midi").value = notificationTimes.midi || "12:00";
      $("time-soir").value = notificationTimes.soir || "20:00";
    };

    // =========================
    // Modal Info
    // =========================
    const escapeHtml = (s) => String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");

    const openInfoModal = (supp) => {
      const g = supplementGuide[supp.name] || { avantages:"‚Äî", inconvenients:"‚Äî", mecanisme:"‚Äî", synergies:"‚Äî" };

      $("modalTitle").textContent = supp.name;
      $("modalDosage").textContent = supp.dosage || "‚Äî";
      $("modalReminder").textContent = supp.reminder || "‚Äî";
      $("modalAdv").textContent = g.avantages || "‚Äî";
      $("modalCons").textContent = g.inconvenients || "‚Äî";
      $("modalMech").textContent = g.mecanisme || "‚Äî";
      $("modalSyn").textContent = g.synergies || "‚Äî";

      $("modalBg").classList.add("show");
    };

    const closeModal = () => $("modalBg").classList.remove("show");

    // =========================
    // Voice recording (dict√©e)
    // =========================
    const startVoiceRecording = (moment) => {
      if (!supportsSpeech()) {
        alert("D√©sol√©, votre navigateur ne supporte pas la reconnaissance vocale.");
        return;
      }
      if (isRecording) return;

      const rec = new window.webkitSpeechRecognition();
      rec.lang = "fr-FR";
      rec.continuous = false;
      rec.interimResults = false;

      rec.onstart = () => { isRecording = true; renderDaily(); toast("üé§ Enregistrement‚Ä¶"); };

      rec.onresult = (event) => {
        const transcript = event.results[0][0].transcript || "";
        const k = keyMoment(selectedDate, moment);
        const prev = voiceNotes[k] || "";
        voiceNotes[k] = (prev + " " + transcript).trim();
        setObj(LS.voice, voiceNotes);
        isRecording = false;
        renderDaily();
        toast("Note ajout√©e");
      };

      rec.onerror = () => {
        isRecording = false;
        renderDaily();
        alert("Erreur d'enregistrement vocal.");
      };

      rec.onend = () => { isRecording = false; renderDaily(); };

      try { rec.start(); } catch { isRecording = false; renderDaily(); }
    };

    // =========================
    // Export CSV (comme Claude)
    // =========================
    const exportCSV = () => {
      let csv = "Date,Moment,Suppl√©ment,Pris,√ânergie,Immunit√©,Stress,Notes Vocales\n";

      // collect unique dates from dailyData keys
      const dates = Object.keys(dailyData).map(k => k.split("-").slice(0,3).join("-"));
      const uniqueDates = [...new Set(dates)].sort();

      uniqueDates.forEach(date => {
        Object.keys(protocol).forEach(moment => {
          protocol[moment].forEach(supp => {
            const k = keyTaken(date, moment, supp.name);
            const taken = dailyData[k] ? "Oui" : "Non";

            const wb = wellbeingScores[keyMoment(date, moment)] || {};
            const note = voiceNotes[keyMoment(date, moment)] || "";

            const e = wb["√ânergie"] ?? "";
            const im = wb["Immunit√©"] ?? "";
            const st = wb["Stress"] ?? "";

            const safeNote = String(note).replace(/"/g,'""');
            csv += `${date},${moment},${supp.name},${taken},${e},${im},${st},"${safeNote}"\n`;
          });
        });
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `protocole_essentiel_${new Date().toISOString().split("T")[0]}.csv`;
      link.click();
      toast("CSV export√©");
    };

    // =========================
    // Events
    // =========================
    document.querySelectorAll(".navBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        currentView = btn.getAttribute("data-view");
        renderNav();

        if (currentView === "daily") renderDaily();
        if (currentView === "analysis") renderAnalysis();
        if (currentView === "guide") renderGuide();
        if (currentView === "settings") renderSettings();
      });
    });

    $("selectedDate").addEventListener("change", (e) => {
      selectedDate = e.target.value || selectedDate;
      renderDaily();
      if (currentView === "analysis") renderAnalysis();
    });

    $("closeModal").addEventListener("click", closeModal);
    $("modalBg").addEventListener("click", (e) => { if (e.target.id === "modalBg") closeModal(); });

    $("exportCSV").addEventListener("click", exportCSV);

    $("saveTimes").addEventListener("click", () => {
      notificationTimes.matin = $("time-matin").value || "08:00";
      notificationTimes.midi  = $("time-midi").value  || "12:00";
      notificationTimes.soir  = $("time-soir").value  || "20:00";
      setObj(LS.times, notificationTimes);
      toast("Heures sauvegard√©es");
      if (currentView === "daily") renderDaily();
    });

    $("clearToday").addEventListener("click", () => {
      const ok = confirm("Effacer toutes les donn√©es pour la date s√©lectionn√©e ?");
      if (!ok) return;

      // remove dailyData keys of that date
      Object.keys(dailyData).forEach(k => { if (k.startsWith(selectedDate + "-")) delete dailyData[k]; });
      Object.keys(wellbeingScores).forEach(k => { if (k.startsWith(selectedDate + "-")) delete wellbeingScores[k]; });
      Object.keys(voiceNotes).forEach(k => { if (k.startsWith(selectedDate + "-")) delete voiceNotes[k]; });

      saveAll();
      toast("Journ√©e effac√©e");
      renderDaily();
      if (currentView === "analysis") renderAnalysis();
    });

    $("clearAll").addEventListener("click", () => {
      const ok = confirm("Tout effacer sur cet appareil ?");
      if (!ok) return;

      dailyData = {};
      wellbeingScores = {};
      voiceNotes = {};
      notificationTimes = { matin:"08:00", midi:"12:00", soir:"20:00" };

      saveAll();
      toast("Tout effac√©");
      renderSettings();
      renderDaily();
      if (currentView === "analysis") renderAnalysis();
    });

    // =========================
    // Init
    // =========================
    (() => {
      // init date
      $("selectedDate").value = selectedDate;

      // initial renders
      renderNav();
      renderDaily();
      renderGuide();
      renderSettings();
      // analysis lazy (mais ok √† init)
      renderAnalysis();
      toast("Charg√© ‚úÖ");
    })();
  </script>
</body>
</html>
