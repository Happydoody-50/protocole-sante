<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#0b1220"/>

  <title>Protocole Essentiel Plus</title>

  <!-- Ic√¥ne sant√© minimal (bleu/rouge/blanc) en SVG -->
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='256' height='256' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='56' fill='%230b1220'/%3E%3Ccircle cx='128' cy='128' r='78' fill='%231f6feb' opacity='0.95'/%3E%3Cpath d='M128 66c-20 0-36 16-36 36 0 28 36 60 36 60s36-32 36-60c0-20-16-36-36-36z' fill='%23ffffff'/%3E%3Crect x='116' y='106' width='24' height='72' rx='10' fill='%23ff3b30'/%3E%3Crect x='92' y='130' width='72' height='24' rx='10' fill='%23ff3b30'/%3E%3C/svg%3E"/>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2f;
      --card:#0f223e;
      --card2:#0f2037;
      --border:rgba(255,255,255,.10);
      --text:#e8f0ff;
      --muted:rgba(232,240,255,.65);
      --muted2:rgba(232,240,255,.45);
      --blue:#3b82f6;
      --blue2:#2563eb;
      --purple:#8b5cf6;
      --green:#22c55e;
      --green2:#16a34a;
      --red:#ff3b30;     /* vifs */
      --yellow:#ffcc00;  /* vifs */
      --greenV:#34c759;  /* vifs */
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:22px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(59,130,246,.24), transparent 60%),
                  radial-gradient(1200px 600px at 80% 10%, rgba(139,92,246,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    .app{
      max-width: 520px;
      margin: 0 auto;
      padding: 14px 14px 92px;
    }

    .top{
      padding-top: 8px;
      text-align:center;
    }
    .title{
      margin: 12px 0 2px;
      font-size: 26px;
      font-weight: 900;
      letter-spacing:.2px;
      background: linear-gradient(90deg, #60a5fa, #a78bfa);
      -webkit-background-clip: text;
      background-clip:text;
      color: transparent;
    }
    .subtitle{
      margin: 0 0 14px;
      font-size: 13px;
      color: var(--muted);
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 14px;
      margin: 10px 0;
    }

    .moment-card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius2);
      padding: 14px;
      margin: 12px 0;
    }

    .moment-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 10px;
    }
    .moment-left{
      display:flex; align-items:center; gap:10px;
      font-size: 20px; font-weight: 900;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      padding: 6px 10px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
    }

    .iconbtn{
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
    }
    .iconbtn.blue{ background: rgba(59,130,246,.95); color:#fff; }
    .iconbtn.purple{ background: rgba(139,92,246,.95); color:#fff; }
    .iconbtn.gray{ background: rgba(255,255,255,.10); color:#fff; border:1px solid var(--border); box-shadow:none; }

    .supp{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px;
      border-radius: var(--radius);
      border: 2px solid transparent;
      background: rgba(255,255,255,.06);
      margin: 10px 0;
    }
    .supp.checked{
      border-color: rgba(34,197,94,.85);
      background: rgba(34,197,94,.10);
    }
    .supp.disabled{
      opacity:.55;
      filter: grayscale(.2);
    }
    .supp-left{
      display:flex; align-items:center; gap:12px;
    }
    .check{
      width: 22px; height: 22px; border-radius: 999px;
      border: 2px solid rgba(255,255,255,.35);
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      color:#001;
      background: transparent;
    }
    .checked .check{
      background: rgba(34,197,94,.95);
      border-color: rgba(34,197,94,.95);
      color:#041;
    }
    .supp-name{
      font-size: 16px;
      font-weight: 900;           /* demand√© */
      color: #ffffff;             /* demand√© */
      line-height: 1.1;
    }
    .supp-dose{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      margin-top: 2px;
    }

    .infoBtn{
      width: 38px; height: 38px;
      border-radius: 999px;
      border:none;
      background: rgba(59,130,246,.88);
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }

    .noteBox{
      margin-top: 10px;
      background: rgba(139,92,246,.10);
      border: 1px solid rgba(139,92,246,.35);
      padding: 12px;
      border-radius: var(--radius);
      color: var(--text);
    }

    textarea{
      width: 100%;
      min-height: 70px;
      resize: vertical;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: #fff;
      outline: none;
      font-size: 14px;
    }

    .small{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.35;
    }

    .progressCard{
      text-align:center;
      padding: 16px;
    }
    .percent{
      font-size: 52px;
      font-weight: 950;
      color: #60a5fa;
      margin: 6px 0 0;
    }
    .percentSub{
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
      margin-top: 4px;
    }

    .nav{
      position: fixed;
      left:0; right:0; bottom:0;
      background: rgba(15,26,47,.92);
      border-top: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      padding: 8px 10px env(safe-area-inset-bottom);
      z-index: 40;
    }
    .navInner{
      max-width: 520px;
      margin: 0 auto;
      display:flex;
      justify-content:space-around;
      gap:8px;
    }
    .navbtn{
      flex:1;
      border:none;
      background: transparent;
      color: rgba(232,240,255,.55);
      font-weight: 900;
      padding: 8px 6px;
      border-radius: 14px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      font-size: 12px;
    }
    .navbtn .ico{ font-size: 18px; }
    .navbtn.active{
      color: #93c5fd;
      background: rgba(59,130,246,.12);
    }

    /* Modal */
    .modalWrap{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 60;
      padding: 16px;
    }
    .modal{
      width: 100%;
      max-width: 440px;
      background: rgba(15,26,47,.96);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .modal h3{ margin: 0 0 8px; color:#93c5fd; font-size: 18px; font-weight: 950; }
    .modal .line{ margin: 10px 0; color: var(--muted); font-size: 13px; }
    .modal .tag{ font-weight: 900; color: #a78bfa; }
    .modal .btn{
      width:100%;
      border:none;
      border-radius: 14px;
      background: rgba(59,130,246,.92);
      color:#fff;
      font-weight: 950;
      padding: 12px;
      cursor:pointer;
      margin-top: 10px;
    }

    /* Analysis */
    .sectionTitle{
      font-size: 18px;
      font-weight: 950;
      color:#93c5fd;
      margin: 2px 0 10px;
    }

    .barRow{
      display:flex; align-items:center; gap:10px;
      margin: 10px 0;
    }
    .barLabel{
      width: 54px;
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      text-transform: capitalize;
    }
    .bar{
      flex:1;
      height: 28px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--border);
      overflow:hidden;
      position:relative;
    }
    .barFill{
      height:100%;
      border-radius: 999px;
      width:0%;
    }
    .barText{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      color:#fff;
      font-size: 12px;
      text-shadow: 0 2px 8px rgba(0,0,0,.6);
    }

    /* Monthly calendar */
    .calHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .monthPicker{
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:#fff;
      font-weight: 900;
    }

    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .dow{
      color: var(--muted);
      font-weight: 950;
      font-size: 11px;
      text-align:center;
      padding: 6px 0;
    }
    .day{
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      color:#fff;
      position:relative;
      user-select:none;
      cursor:pointer;
    }
    .day.off{
      opacity:.28;
      cursor:default;
    }
    .day .pct{
      position:absolute;
      bottom: 4px;
      right: 6px;
      font-size: 10px;
      font-weight: 950;
      color: rgba(255,255,255,.85);
    }

    /* VIVID colors demanded */
    .day.red{ background: rgba(255,59,48,.92); border-color: rgba(255,59,48,.95); }
    .day.yellow{ background: rgba(255,204,0,.92); border-color: rgba(255,204,0,.95); color:#1a1a1a; }
    .day.green{ background: rgba(52,199,89,.92); border-color: rgba(52,199,89,.95); color:#062012; }

    /* Settings export panel toggle */
    .btnWide{
      width:100%;
      border:none;
      border-radius: 14px;
      padding: 12px;
      font-weight: 950;
      cursor:pointer;
      color:#fff;
    }
    .btnGreen{ background: rgba(34,197,94,.95); }
    .btnBlue{ background: rgba(59,130,246,.95); }
    .btnGray{ background: rgba(255,255,255,.10); border:1px solid var(--border); }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div class="title">Protocole Essentiel Plus</div>
      <div class="subtitle">Suivi intelligent ‚Ä¢ donn√©es stock√©es sur ton appareil</div>
    </div>

    <!-- Views -->
    <div id="view-daily" class="view"></div>
    <div id="view-analysis" class="view hidden"></div>
    <div id="view-guide" class="view hidden"></div>
    <div id="view-settings" class="view hidden"></div>
  </div>

  <!-- Modal -->
  <div id="modalWrap" class="modalWrap" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <h3 id="modalTitle">Titre</h3>
      <div class="line"><span class="tag">üì¶ Dosage:</span> <span id="modalDose"></span></div>
      <div class="line"><span class="tag">üí° Rappel:</span> <span id="modalRem"></span></div>
      <div class="line"><span class="tag">‚úÖ Avantages:</span> <span id="modalAdv"></span></div>
      <div class="line"><span class="tag">‚ö†Ô∏è Inconv√©nients:</span> <span id="modalInc"></span></div>
      <div class="line"><span class="tag">üî¨ M√©canisme:</span> <span id="modalMec"></span></div>
      <div class="line"><span class="tag">ü§ù Synergies:</span> <span id="modalSyn"></span></div>
      <button class="btn" onclick="closeModal()">Fermer</button>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="nav">
    <div class="navInner">
      <button class="navbtn active" id="nav-daily" onclick="switchView('daily')">
        <div class="ico">üïí</div><div>Quotidien</div>
      </button>
      <button class="navbtn" id="nav-analysis" onclick="switchView('analysis')">
        <div class="ico">üìà</div><div>Analyse</div>
      </button>
      <button class="navbtn" id="nav-guide" onclick="switchView('guide')">
        <div class="ico">üìñ</div><div>Guide</div>
      </button>
      <button class="navbtn" id="nav-settings" onclick="switchView('settings')">
        <div class="ico">‚öôÔ∏è</div><div>R√©glages</div>
      </button>
    </div>
  </div>

  <script>
    // ------------------------------
    // Data model (localStorage keys)
    // ------------------------------
    const LS = {
      taken: "protocolData_v1",
      notes: "voiceNotes_v1",
      scores: "wellbeingScores_v1",
      times: "notificationTimes_v1"
    };

    function loadObj(key, fallback){
      try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
      catch(e){ return fallback; }
    }
    function saveObj(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }

    // ------------------------------
    // Protocol (same as you wanted)
    // ------------------------------
    const protocol = {
      matin: [
        { name:"Bleu de M√©thyl√®ne", dosage:"5 gouttes", reminder:"√Ä jeun, dilu√© dans un verre d'eau" },
        { name:"Complexe B", dosage:"1 capsule", reminder:"Avec le petit-d√©jeuner pour meilleure absorption" },
        { name:"Vita-D3", dosage:"1 capsule", reminder:"Avec un repas contenant des graisses" }
      ],
      midi: [
        { name:"Curcuma", dosage:"500mg", reminder:"Avec poivre noir pour biodisponibilit√©" },
        { name:"Gingembre", dosage:"250mg", reminder:"Pendant ou apr√®s le repas" }
      ],
      soir: [
        { name:"Ashwagandha", dosage:"300mg", reminder:"Au d√Æner (3 semaines ON / 1 semaine OFF)" },
        { name:"Zinc", dosage:"15mg", reminder:"Au d√Æner, pas avec calcium" },
        { name:"Synermag/Magn√©sium", dosage:"200mg", reminder:"Au coucher pour favoriser le sommeil" }
      ]
    };

    const supplementGuide = {
      "Bleu de M√©thyl√®ne": {
        avantages:"Am√©liore fonction mitochondriale, neuroprotecteur, antioxydant puissant",
        inconvenients:"Coloration urine/selles, interactions m√©dicamenteuses, √©viter si G6PD",
        mecanisme:"Optimise la cha√Æne respiratoire ‚Üí √©nergie cellulaire",
        synergies:"NAD+ et CoQ10"
      },
      "Complexe B": {
        avantages:"√ânergie, m√©tabolisme, fonction cognitive, humeur",
        inconvenients:"Urine jaune fluo, possible naus√©e √† jeun",
        mecanisme:"Cofacteurs essentiels (√©nergie + neurotransmetteurs)",
        synergies:"Magn√©sium (activation optimale)"
      },
      "Vita-D3": {
        avantages:"Immunit√©, os, humeur, fonction musculaire",
        inconvenients:"Toxicit√© si surdosage, calcification si K2 absent",
        mecanisme:"Hormone st√©ro√Øde qui r√©gule 3000+ g√®nes",
        synergies:"K2 + graisses alimentaires"
      },
      "Curcuma": {
        avantages:"Anti-inflammatoire, antioxydant, neuroprotecteur",
        inconvenients:"Biodisponibilit√© faible seul, possible trouble gastrique",
        mecanisme:"Inhibe voies inflammatoires (ex: NF-kB)",
        synergies:"Poivre noir + gingembre"
      },
      "Gingembre": {
        avantages:"Anti-naus√©e, digestion, anti-inflammatoire",
        inconvenients:"Peut fluidifier le sang (prudence)",
        mecanisme:"Ging√©rols ‚Üí modulation inflammation",
        synergies:"Curcuma"
      },
      "Ashwagandha": {
        avantages:"Anti-stress, cortisol, sommeil, force",
        inconvenients:"Cycle requis, somnolence possible",
        mecanisme:"Axe HPA + r√©cepteurs GABA",
        synergies:"Magn√©sium"
      },
      "Zinc": {
        avantages:"Immunit√©, cicatrisation, enzymes",
        inconvenients:"Naus√©e estomac vide, exc√®s ‚Üí cuivre",
        mecanisme:"Cofacteur enzymatique + r√©gulateur immunitaire",
        synergies:"Vitamine C (√©viter calcium en m√™me temps)"
      },
      "Synermag/Magn√©sium": {
        avantages:"Sommeil, relaxation, fonctions enzymatiques",
        inconvenients:"Effet laxatif selon forme, interactions antibiotiques",
        mecanisme:"Antagoniste calcium, soutien GABA",
        synergies:"B6 + D3"
      }
    };

    // Ashwagandha rest week: 3 ON / 1 OFF
    function isAshwagandhaRestWeek(dateStr){
      const d = new Date(dateStr + "T00:00:00");
      const start = new Date(d.getFullYear(), 0, 1);
      const weekOfYear = Math.floor((d - start) / 604800000); // 7 days ms
      return (weekOfYear % 4) === 3;
    }

    // ------------------------------
    // App state
    // ------------------------------
    let selectedDate = new Date().toISOString().slice(0,10);
    let selectedMonth = new Date().toISOString().slice(0,7);
    let currentView = "daily";
    let exportPanelOpen = false;

    // stored
    let taken = loadObj(LS.taken, {});      // { "YYYY-MM-DD-matin-Nom": true }
    let notes = loadObj(LS.notes, {});      // { "YYYY-MM-DD-matin": "text" }
    let scores = loadObj(LS.scores, {});    // { "YYYY-MM-DD-matin": {Energie:5,...} }
    let times = loadObj(LS.times, { matin:"08:00", midi:"12:00", soir:"20:00" });

    // ------------------------------
    // Helpers
    // ------------------------------
    const momentEmoji = { matin:"üåÖ", midi:"‚òÄÔ∏è", soir:"üåô" };
    const momentLabel = { matin:"Matin", midi:"Midi", soir:"Soir" };

    function keyTaken(dateStr, moment, suppName){
      return `${dateStr}-${moment}-${suppName}`;
    }
    function keyNote(dateStr, moment){
      return `${dateStr}-${moment}`;
    }
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function getDayCompletion(dateStr){
      let total=0, done=0;
      Object.keys(protocol).forEach(m=>{
        protocol[m].forEach(s=>{
          if (s.name==="Ashwagandha" && isAshwagandhaRestWeek(dateStr)) return;
          total++;
          if (taken[keyTaken(dateStr, m, s.name)]) done++;
        });
      });
      return total ? Math.round((done/total)*100) : 0;
    }

    function colorClassFromPct(p){
      if (p < 50) return "red";
      if (p < 80) return "yellow";
      return "green";
    }

    // ------------------------------
    // Dictation support (optional)
    // ------------------------------
    function tryWebDictation(textareaId){
      const ta = document.getElementById(textareaId);
      if (!ta) return;

      // If browser SpeechRecognition exists
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR){
        alert("Astuce: utilise le micro du clavier (Gboard/Samsung) dans la zone de note üôÇ");
        ta.focus();
        return;
      }

      const rec = new SR();
      rec.lang = "fr-FR";
      rec.continuous = false;
      rec.interimResults = false;

      rec.onresult = (e)=>{
        const text = e.results[0][0].transcript;
        ta.value = (ta.value ? (ta.value.trim()+" ") : "") + text;
        ta.dispatchEvent(new Event("input"));
      };
      rec.onerror = ()=>{
        alert("Dict√©e navigateur indisponible ici. Utilise le micro du clavier dans la zone de note üôÇ");
      };
      rec.start();
    }

    // ------------------------------
    // Modal
    // ------------------------------
    function openModal(supp){
      const g = supplementGuide[supp.name] || {};
      document.getElementById("modalTitle").textContent = supp.name;
      document.getElementById("modalDose").textContent = supp.dosage || "";
      document.getElementById("modalRem").textContent  = supp.reminder || "";
      document.getElementById("modalAdv").textContent  = g.avantages || "‚Äî";
      document.getElementById("modalInc").textContent  = g.inconvenients || "‚Äî";
      document.getElementById("modalMec").textContent  = g.mecanisme || "‚Äî";
      document.getElementById("modalSyn").textContent  = g.synergies || "‚Äî";
      document.getElementById("modalWrap").style.display = "flex";
    }
    function closeModal(){
      document.getElementById("modalWrap").style.display = "none";
    }

    // ------------------------------
    // Export Monthly (CSV + TXT)
    // ------------------------------
    function downloadFile(content, filename, mime){
      const blob = new Blob([content], {type:mime});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    function exportMonthlyNotesCSV(month){
      if(!month){ alert("Choisis un mois d‚Äôabord"); return; }
      const entries = Object.entries(notes)
        .filter(([k,v]) => k.startsWith(`${month}-`) && String(v||"").trim().length>0)
        .map(([k,v])=>{
          const parts = k.split("-");
          const date = `${parts[0]}-${parts[1]}-${parts[2]}`;
          const moment = parts[3] || "";
          return {date, moment, note:String(v).trim()};
        })
        .sort((a,b)=> (a.date+a.moment).localeCompare(b.date+b.moment));

      let csv = "Mois,Date,Moment,Note\n";
      entries.forEach(e=>{
        csv += `${month},${e.date},${e.moment},"${e.note.replace(/"/g,'""')}"\n`;
      });

      downloadFile(csv, `notes_${month}.csv`, "text/csv;charset=utf-8;");
    }

    function exportMonthlyNotesTXT(month){
      if(!month){ alert("Choisis un mois d‚Äôabord"); return; }

      const keys = Object.keys(notes).filter(
        k => k.startsWith(`${month}-`) && String(notes[k]||"").trim().length>0
      );
      const dates = [...new Set(keys.map(k=> k.split("-").slice(0,3).join("-")))].sort();

      let txt = `NOTES MENSUELLES ‚Äî ${month}\n`;
      txt += `Export√© le ${new Date().toISOString().slice(0,10)}\n`;
      txt += `========================================\n\n`;

      if(!dates.length){
        txt += "Aucune note pour ce mois.\n";
      } else {
        dates.forEach(d=>{
          txt += `üìÖ ${d}\n`;
          txt += `----------------------------------------\n`;
          ["matin","midi","soir"].forEach(m=>{
            const val = String(notes[`${d}-${m}`] || "").trim();
            if(val) txt += `${momentLabel[m]}: ${val}\n`;
          });
          txt += "\n";
        });
      }

      downloadFile(txt, `notes_${month}.txt`, "text/plain;charset=utf-8;");
    }

    // Settings export toggle (does NOT block other screens)
    function toggleExportPanel(force){
      exportPanelOpen = (typeof force === "boolean") ? force : !exportPanelOpen;
      const panel = document.getElementById("exportPanel");
      if(panel) panel.style.display = exportPanelOpen ? "block" : "none";
    }

    // ------------------------------
    // Rendering
    // ------------------------------
    function switchView(view){
      currentView = view;
      ["daily","analysis","guide","settings"].forEach(v=>{
        document.getElementById(`view-${v}`).classList.toggle("hidden", v!==view);
        document.getElementById(`nav-${v}`).classList.toggle("active", v===view);
      });
      render();
    }

    function render(){
      renderDaily();
      renderAnalysis();
      renderGuide();
      renderSettings();
    }

    function renderDaily(){
      const root = document.getElementById("view-daily");
      const pct = getDayCompletion(selectedDate);

      let html = `
        <div class="card">
          <div class="row">
            <div style="font-weight:950;color:#93c5fd;font-size:18px;">Suivi Quotidien</div>
            <input type="date" value="${selectedDate}"
              onchange="onChangeDate(this.value)"
              style="padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:#fff;font-weight:900;">
          </div>
          <div class="small">Choisis ta date et coche tes suppl√©ments. Notes: dicte avec le <b>micro du clavier</b> dans la zone de texte.</div>
        </div>
      `;

      Object.keys(protocol).forEach(moment=>{
        const restAshwa = (moment==="soir") && isAshwagandhaRestWeek(selectedDate);
        html += `
          <div class="moment-card">
            <div class="moment-head">
              <div class="moment-left">
                <span>${momentEmoji[moment]}</span>
                <span style="color:#93c5fd">${momentLabel[moment]}</span>
                <span class="pill">üîî ${times[moment] || ""}</span>
              </div>

              <div style="display:flex;gap:10px;">
                <button class="iconbtn blue" onclick="scrollToNotes('${moment}')">üîä</button>
                <button class="iconbtn purple" onclick="startDictationFor('${moment}')">üé§</button>
              </div>
            </div>
        `;

        protocol[moment].forEach(supp=>{
          const isAshwa = supp.name==="Ashwagandha";
          const isRest = isAshwa && isAshwagandhaRestWeek(selectedDate);
          const k = keyTaken(selectedDate, moment, supp.name);
          const checked = !!taken[k];

          html += `
            <div class="supp ${checked ? "checked":""} ${isRest ? "disabled":""}"
                 onclick="${isRest ? "" : `toggleTaken('${moment}', '${escapeJs(supp.name)}')`}">
              <div class="supp-left">
                <div class="check">${checked ? "‚úì" : ""}</div>
                <div>
                  <div class="supp-name">${escapeHtml(supp.name)}</div>
                  <div class="supp-dose">${escapeHtml(supp.dosage)}</div>
                </div>
              </div>
              <button class="infoBtn" onclick="event.stopPropagation(); openModalByName('${moment}', '${escapeJs(supp.name)}')">i</button>
            </div>
          `;
          if(isRest){
            html += `<div class="small" style="color: rgba(255,204,0,.95); font-weight:900; margin-top:-6px;">Semaine de repos (Ashwagandha)</div>`;
          }
        });

        // Notes (IMPORTANT: same for matin/midi/soir)
        const nk = keyNote(selectedDate, moment);
        const noteVal = notes[nk] ? escapeHtml(notes[nk]) : "";

        const textareaId = `note_${moment}`;
        html += `
            <div class="noteBox" id="notes_${moment}">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;">
                <div style="font-weight:950;color:#c4b5fd;">üìù Note ${momentLabel[moment]}</div>
                <button class="iconbtn gray" style="width:40px;height:40px;" onclick="startDictationFor('${moment}')">üéôÔ∏è</button>
              </div>
              <textarea id="${textareaId}" placeholder="√âcris ou dicte ici..."
                oninput="onNoteChange('${moment}', this.value)">${noteVal}</textarea>
              <div class="small">Astuce: sur Android, dicte avec le micro du clavier dans la bo√Æte de texte. Le bouton üéôÔ∏è essaie aussi la dict√©e navigateur si disponible.</div>
            </div>
          </div>
        `;
      });

      html += `
        <div class="card progressCard">
          <div class="percent">${pct}%</div>
          <div class="percentSub">Protocole compl√©t√©</div>
        </div>
      `;

      root.innerHTML = html;
    }

    function renderAnalysis(){
      const root = document.getElementById("view-analysis");

      // weekly (last 7 days)
      const weekData = [];
      for(let i=6;i>=0;i--){
        const d = new Date(selectedDate+"T00:00:00");
        d.setDate(d.getDate()-i);
        const ds = d.toISOString().slice(0,10);
        const day = d.toLocaleDateString("fr-FR",{weekday:"short"});
        weekData.push({ds, day, pct: getDayCompletion(ds)});
      }
      const avg = Math.round(weekData.reduce((s,x)=>s+x.pct,0)/weekData.length);

      // monthly calendar
      const m = selectedMonth;
      const [yy,mm] = m.split("-").map(x=>parseInt(x,10));
      const first = new Date(yy, mm-1, 1);
      const last = new Date(yy, mm, 0);
      const daysInMonth = last.getDate();
      const startDow = (first.getDay()+6)%7; // Monday=0
      const monthName = first.toLocaleDateString("fr-FR",{month:"long", year:"numeric"});

      let html = `
        <div class="card">
          <div class="row">
            <div class="sectionTitle">Analyse</div>
            <button class="btnWide btnGreen" style="width:auto;padding:10px 12px;"
              onclick="exportMonthlyNotesCSV(selectedMonth)">Export CSV</button>
          </div>

          <div class="card" style="margin-top:12px;background:linear-gradient(135deg, rgba(34,197,94,.18), rgba(59,130,246,.15));">
            <div style="text-align:center;">
              <div style="font-size:58px;font-weight:950;color:rgba(34,197,94,.95);">${avg}%</div>
              <div style="color:var(--muted);font-weight:900;">Conformit√© Hebdomadaire</div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <div class="sectionTitle">7 derniers jours</div>
      `;

      weekData.forEach(w=>{
        const cls = (w.pct>=80) ? "rgba(34,197,94,.95)" : (w.pct>=50) ? "rgba(255,204,0,.95)" : "rgba(255,59,48,.95)";
        html += `
          <div class="barRow">
            <div class="barLabel">${w.day}</div>
            <div class="bar">
              <div class="barFill" style="width:${w.pct}%; background:${cls};"></div>
              <div class="barText">${w.pct}%</div>
            </div>
          </div>
        `;
      });

      html += `
          </div>
        </div>

        <div class="card">
          <div class="calHead">
            <div class="sectionTitle" style="margin:0;">Calendrier Mensuel</div>
          </div>

          <input class="monthPicker" type="month" value="${selectedMonth}"
            onchange="onChangeMonth(this.value)">

          <div class="small" style="margin-top:8px;">
            Couleurs vives: <b style="color:var(--red)">Rouge</b> &lt;50% ‚Ä¢
            <b style="color:var(--yellow)">Jaune</b> 50‚Äì79% ‚Ä¢
            <b style="color:var(--greenV)">Vert</b> ‚â•80%
          </div>

          <div class="calGrid" style="margin-top:10px;">
            ${["L","M","M","J","V","S","D"].map(x=>`<div class="dow">${x}</div>`).join("")}
          </div>

          <div class="calGrid">
      `;

      // Leading blanks (previous month)
      for(let i=0;i<startDow;i++){
        html += `<div class="day off"></div>`;
      }

      for(let day=1; day<=daysInMonth; day++){
        const ds = `${yy}-${String(mm).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
        const pct = getDayCompletion(ds);
        const cls = colorClassFromPct(pct);
        const isToday = (ds === new Date().toISOString().slice(0,10));
        html += `
          <div class="day ${cls}" onclick="onPickCalendarDate('${ds}')" title="${ds}"
               style="${isToday ? "box-shadow:0 0 0 3px rgba(255,255,255,.35) inset;" : ""}">
            ${day}
            <div class="pct">${pct}%</div>
          </div>
        `;
      }

      // Trailing blanks to complete rows
      const totalCells = startDow + daysInMonth;
      const trailing = (7 - (totalCells % 7)) % 7;
      for(let i=0;i<trailing;i++){
        html += `<div class="day off"></div>`;
      }

      html += `
          </div>

          <div class="small" style="margin-top:10px;">
            Astuce: touche un jour du calendrier pour aller direct √† cette date (onglet Quotidien).
          </div>
        </div>
      `;

      root.innerHTML = html;
    }

    function renderGuide(){
      const root = document.getElementById("view-guide");

      let html = `<div class="card"><div class="sectionTitle">Guide D√©taill√©</div>`;
      Object.entries(supplementGuide).forEach(([name, info])=>{
        html += `
          <div class="card" style="margin-top:10px;">
            <div style="font-weight:950;color:#93c5fd;font-size:18px;margin-bottom:8px;">${escapeHtml(name)}</div>
            <div class="line"><span class="tag">‚úÖ Avantages:</span> ${escapeHtml(info.avantages)}</div>
            <div class="line"><span class="tag">‚ö†Ô∏è Inconv√©nients:</span> ${escapeHtml(info.inconvenients)}</div>
            <div class="line"><span class="tag">üî¨ M√©canisme:</span> ${escapeHtml(info.mecanisme)}</div>
            <div class="line"><span class="tag">ü§ù Synergies:</span> ${escapeHtml(info.synergies)}</div>
          </div>
        `;
      });
      html += `</div>`;

      root.innerHTML = html;
    }

    function renderSettings(){
      const root = document.getElementById("view-settings");

      let html = `
        <div class="card">
          <div class="sectionTitle">R√©glages</div>

          <div class="card" style="margin-top:12px;">
            <div style="font-weight:950;color:#93c5fd;font-size:16px;margin-bottom:10px;">‚è∞ Heures (affichage)</div>

            ${["matin","midi","soir"].map(m=>`
              <div style="margin-bottom:10px;">
                <div style="color:var(--muted);font-weight:900;margin-bottom:6px;">${momentEmoji[m]} ${momentLabel[m]}</div>
                <input type="time" value="${times[m] || ""}" onchange="onTimeChange('${m}', this.value)"
                  style="width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:#fff;font-weight:900;">
              </div>
            `).join("")}
          </div>

          <div class="card" style="margin-top:12px;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <div style="font-weight:950;color:#93c5fd;font-size:16px;">üóìÔ∏è Export des notes mensuelles</div>
              <button class="btnWide btnGray" style="width:auto;padding:10px 12px;" onclick="toggleExportPanel()">
                Afficher / Masquer
              </button>
            </div>

            <div id="exportPanel" style="display:${exportPanelOpen ? "block":"none"}; margin-top:12px;">
              <label style="font-size:12px; color:rgba(232,240,255,.70); font-weight:900;">Choisir un mois</label>
              <input id="monthPicker" type="month" class="monthPicker" value="${selectedMonth}" onchange="onChangeMonth(this.value)">

              <button class="btnWide btnGreen" style="margin-top:10px;" onclick="exportMonthlyNotesCSV(selectedMonth)">
                T√©l√©charger notes du mois (CSV)
              </button>
              <button class="btnWide btnBlue" style="margin-top:10px;" onclick="exportMonthlyNotesTXT(selectedMonth)">
                T√©l√©charger notes du mois (TXT)
              </button>
              <button class="btnWide btnGray" style="margin-top:10px;" onclick="toggleExportPanel(false)">
                Fermer
              </button>

              <div class="small">CSV = Excel/Sheets ‚Ä¢ TXT = lisible pour m√©decin</div>
            </div>
          </div>

          <div class="card" style="margin-top:12px;background:linear-gradient(135deg, rgba(139,92,246,.14), rgba(255,59,48,.10));">
            <div style="font-weight:950;color:#c4b5fd;">üì± √Ä propos</div>
            <div class="small">
              Protocole Essentiel Plus ‚Ä¢ v2 (HTML simple)<br/>
              Donn√©es stock√©es localement (sur ton appareil).<br/>
              Si tu changes de t√©l√©phone: pense √† exporter tes notes mensuelles.
            </div>
          </div>

          <button class="btnWide btnGray" style="margin-top:12px;" onclick="dangerReset()">
            R√©initialiser (effacer donn√©es locales)
          </button>
        </div>
      `;

      root.innerHTML = html;
    }

    // ------------------------------
    // Event handlers
    // ------------------------------
    function onChangeDate(val){
      selectedDate = val;
      render();
    }
    function onPickCalendarDate(ds){
      selectedDate = ds;
      switchView("daily");
    }
    function onChangeMonth(val){
      if(val) selectedMonth = val;
      render();
    }

    function toggleTaken(moment, suppName){
      const k = keyTaken(selectedDate, moment, suppName);
      taken[k] = !taken[k];
      saveObj(LS.taken, taken);
      renderDaily(); // fast refresh
      // also update analysis percent if user jumps
      renderAnalysis();
    }

    function onNoteChange(moment, text){
      const k = keyNote(selectedDate, moment);
      notes[k] = text;
      saveObj(LS.notes, notes);
      // no full render needed
    }

    function openModalByName(moment, suppName){
      const supp = protocol[moment].find(s=> s.name===suppName);
      if(supp) openModal(supp);
    }

    function startDictationFor(moment){
      // We'll try browser dictation into the correct textarea.
      // If not supported, user will use keyboard mic.
      const id = `note_${moment}`;
      tryWebDictation(id);
      // also scroll to the note box so user sees it
      scrollToNotes(moment);
    }

    function scrollToNotes(moment){
      const el = document.getElementById(`notes_${moment}`);
      if(el) el.scrollIntoView({behavior:"smooth", block:"center"});
    }

    function onTimeChange(moment, val){
      times[moment] = val;
      saveObj(LS.times, times);
      renderDaily();
      renderSettings();
    }

    function dangerReset(){
      const ok = confirm("Effacer toutes les donn√©es locales (cases coch√©es + notes + r√©glages) ?");
      if(!ok) return;
      localStorage.removeItem(LS.taken);
      localStorage.removeItem(LS.notes);
      localStorage.removeItem(LS.scores);
      localStorage.removeItem(LS.times);
      taken = {};
      notes = {};
      scores = {};
      times = { matin:"08:00", midi:"12:00", soir:"20:00" };
      exportPanelOpen = false;
      render();
      alert("OK. Donn√©es effac√©es.");
    }

    // ------------------------------
    // Utils: escaping
    // ------------------------------
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeJs(s){
      return String(s ?? "")
        .replaceAll("\\","\\\\")
        .replaceAll("'","\\'")
        .replaceAll('"','\\"');
    }

    // ------------------------------
    // Boot
    // ------------------------------
    (function init(){
      // Render once
      render();
    })();
  </script>
</body>
</html>
